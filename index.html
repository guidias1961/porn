<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PORN – Orion Peep Show</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ff9900">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Monkey-patch no topo: reescreve QUALQUER fetch/XHR/Request para o proxy local -->
<script>
(function(){
  const ADDR_RE = /^https?:\/\/scan\.pulsechain\.com\/api\/v2\/addresses\/(0x[a-fA-F0-9]{40})\/?$/i;
  function toLocal(u){ const m = u && u.match(ADDR_RE); return m ? `/api/explorer/addresses/${m[1]}` : null; }

  const _fetch = window.fetch.bind(window);
  window.fetch = function(input, init){
    try{
      const url = typeof input === 'string' ? input : input && input.url;
      const local = toLocal(url);
      if(local) return _fetch(local, init);
    }catch(_){}
    return _fetch(input, init);
  };

  const _open = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function(method, url){
    try{
      const local = toLocal(url);
      if(local) arguments[1] = local;
    }catch(_){}
    return _open.apply(this, arguments);
  };

  const _Request = window.Request;
  window.Request = new Proxy(_Request, {
    construct(target, args){
      try{
        if(args && typeof args[0] === 'string'){
          const local = toLocal(args[0]);
          if(local) args[0] = local;
        }
      }catch(_){}
      return new target(...args);
    }
  });
})();
</script>

<style>
  :root{--bg:#0b0b0c;--panel:#111112;--panel2:#1c1c1e;--text:#e9e9ea;--muted:#a0a0a3;--accent:#ff9900;--accent2:#ff0066;--blue:#1d9bf0}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Open Sans',Arial,sans-serif;font-size:14px;line-height:1.45}
  a{color:#5aa9ff;text-decoration:none}
  header{background:#000;border-bottom:2px solid #1a1a1a;color:#fff}
  .topbar{max-width:1280px;margin:0 auto;display:flex;align-items:center;gap:18px;padding:10px 16px}
  .logo{display:flex;align-items:baseline;gap:6px;font-family:'Bebas Neue',sans-serif;letter-spacing:.5px}
  .logo .lhs{background:#000;color:#fff;padding:6px 10px;font-size:30px;line-height:1;border:2px solid #fff}
  .logo .rhs{background:var(--accent);color:#000;padding:6px 10px;font-size:30px;line-height:1;font-weight:900}
  .logo small{display:block;font:600 11px/1 'Open Sans',sans-serif;color:#bbb;margin-left:4px;margin-top:2px}
  .nav{display:flex;gap:16px;margin-left:8px;flex-wrap:wrap}
  .nav a{color:#ddd;font-weight:700;text-transform:uppercase}
  .nav a:hover{color:#fff}
  .search{margin-left:auto;display:flex;align-items:center;gap:6px}
  .search input{width:460px;max-width:50vw;background:#0f0f0f;border:1px solid #2a2a2a;color:#e9e9ea;padding:8px 10px;outline:none;font-size:14px;border-radius:0}
  .btn{background:#222;border:1px solid #313131;color:#fff;padding:8px 12px;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:.3px;border-radius:0}
  .btn:hover{border-color:#444}
  .btn.accent{background:var(--accent);border-color:var(--accent);color:#000}
  .btn.green{background:#0f8c36;border-color:#0f8c36}
  .btn.twitter{background:var(--blue);border-color:var(--blue)}
  .subbar{border-top:1px solid #1a1a1a;background:#0a0a0a}
  .subbar .wrap{max-width:1280px;margin:0 auto;padding:8px 16px;display:flex;align-items:center;gap:10px;color:#bbb}
  main{max-width:1280px;margin:0 auto;padding:16px}
  .row{display:flex;gap:16px;align-items:flex-start}
  .panel{background:var(--panel);border:1px solid #222;padding:12px;color:#ddd}
  .hero{flex:1}
  .side{width:360px}
  h1,h2{font-family:'Bebas Neue',sans-serif;margin:0 0 6px;letter-spacing:.3px}
  h1{font-size:34px} h2{font-size:22px}
  .muted{color:var(--muted)}
  .banner{background:#0a0a0a;border:1px dashed #2e2e2e;color:#f7d083;padding:8px 10px}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:820px){.grid{grid-template-columns:1fr} .side{display:none}}
  .card{background:var(--panel2);border:1px solid #2a2a2a;padding:8px;position:relative}
  .thumb{background:#070707;border:1px solid #222;height:120px;display:flex;align-items:center;justify-content:center;color:#666;font-weight:700}
  .titleLine{margin-top:8px;font-weight:700;color:#fff}
  .meta{display:flex;justify-content:space-between;color:#a8a8ab;font-size:12px;margin-top:4px}
  .shareRow{display:flex;gap:6px;margin-top:8px}
  .live{position:absolute;top:8px;left:8px;background:var(--accent2);color:#fff;font-weight:900;padding:2px 6px;font-size:11px}
  .error{color:#ffb3b3}
  footer{padding:20px;color:#999;text-align:center}
  .kbd{background:#111;padding:2px 4px;border:1px solid #333;color:#ccc}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .list{background:#0e0e0f;border:1px solid #222;padding:8px}
  .li{display:flex;justify-content:space-between;border-top:1px solid #222;padding:6px 0}
  .li:first-child{border-top:0}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="logo">
      <div class="lhs">PORN</div><div class="rhs">HUB</div>
      <small>Pulse Orion Network • Orion Peep Show</small>
    </div>
    <nav class="nav">
      <a href="#" onclick="return false">TRENDING</a>
      <a href="#" onclick="return false">LIVE</a>
      <a href="#" onclick="return false">WALLETS</a>
      <a href="#" onclick="return false">EXPOSED</a>
    </nav>
    <div class="search">
      <input id="addrInput" placeholder="Wallet or token 0x... then Analyze">
      <button class="btn accent" id="analyzeBtn">Analyze</button>
      <button class="btn green" id="buyBtn">$PORN Buy</button>
    </div>
  </div>
  <div class="subbar">
    <div class="wrap" style="gap:14px;flex-wrap:wrap">
      <span>status:</span>
      <span id="apiStatus" class="muted">ready</span>
      <span style="margin-left:auto" class="muted">proxy /api/explorer/addresses/{hash}</span>
    </div>
  </div>
</header>

<main>
  <div class="row">
    <section class="panel hero">
      <h1>Live wallets exposed</h1>
      <div class="banner" id="hint">Paste a wallet or token. We call the explorer through our proxy, craft an erotic background message based on behavior, and record it server side to build Trending.</div>
      <div id="grid" class="grid"></div>

      <h2 style="margin-top:16px">Trending</h2>
      <div class="cols">
        <div class="list">
          <div style="font-weight:800;margin-bottom:6px">Wallets</div>
          <div id="trendWallets"></div>
        </div>
        <div class="list">
          <div style="font-weight:800;margin-bottom:6px">Tokens</div>
          <div id="trendTokens"></div>
        </div>
      </div>
    </section>

    <aside class="panel side">
      <h2>How it works</h2>
      <p class="muted">1. GET <code>/api/explorer/addresses/{hash}</code></p>
      <p class="muted">2. Detect wallet or token contract</p>
      <p class="muted">3. Build message from balance, tx count, holders, reputation</p>
      <p class="muted">4. Persist with <code>POST /api/record</code> and show in Trending</p>
      <hr style="border:0;border-top:1px solid #222;margin:12px 0">
      <button class="btn twitter" id="tweetSite">Tweet the site</button>
    </aside>
  </div>
</main>

<footer>© PORN • Orion Peep Show • For entertainment only</footer>

<script>
// registra service worker para interceptar chamadas externas residuais
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}

const DEFAULT_USD_RATE = 0.00002;
const MAX_CARDS = 24;
const PULSEX_BUY_URL = "https://app.pulsex.com/";

const addrInput = document.getElementById('addrInput');
const analyzeBtn = document.getElementById('analyzeBtn');
const grid = document.getElementById('grid');
const apiStatus = document.getElementById('apiStatus');
const trendWallets = document.getElementById('trendWallets');
const trendTokens  = document.getElementById('trendTokens');

const shortAddr = a => a ? (a.slice(0,6)+"..."+a.slice(-4)) : "unknown";
function toFloat(x){ if(x==null) return 0; const n=Number(x); if(!isFinite(n)) return 0; return n>1e12 ? n/1e18 : n; }
function pickRate(obj, top){ return Number(obj?.exchange_rate)||Number(obj?.token?.exchange_rate)||Number(top?.exchange_rate)||DEFAULT_USD_RATE; }

function eroticMessage(ctx){
  const { type, usd, txs, holders, verified, reputation } = ctx;
  const usdStr = "$"+usd.toLocaleString(undefined,{maximumFractionDigits:2});
  if(type==='wallet'){
    const tier = usd>100000 ? "whale" : usd>10000 ? "alpha" : usd>1000 ? "tease" : usd>100 ? "soft" : "bare";
    const act  = txs>500 ? "experienced performer" : txs>100 ? "regular flirt" : "shy lurker";
    const mood = usd<10 ? "broke and brazen" : usd>5000 ? "loaded and shameless" : "curious and reckless";
    return `This wallet goes ${tier}: ${usdStr} on display, ${act}, ${mood}. The window fogs up as it breathes liquidity.`;
  }
  const crowd = holders>50000 ? "packed room screaming for more" : holders>5000 ? "eager audience" : holders>500 ? "intimate crowd" : "private booth";
  const badge = verified ? "verified star" : "masked newcomer";
  const rep   = reputation && reputation!=="ok" ? `with a ${reputation} reputation` : "with clean lights";
  return `A ${badge} enters the stage for a ${crowd}. Liquidity arches, ${usdStr} teased in view, ${rep}. Will it keep the show or fade the lights?`;
}

function composeTitle(address, usd){
  return `${shortAddr(address)} is showing it all: $${usd.toLocaleString(undefined,{maximumFractionDigits:2})} in liquidity left unlocked.`;
}

async function analyze(addr){
  // sempre via proxy local
  const url = `/api/explorer/addresses/${addr}`;
  try{
    apiStatus.textContent = "querying";
    const r = await fetch(url, { headers:{ accept:'application/json' } });
    if(!r.ok){ apiStatus.textContent = "API " + r.status; return; }
    const data = await r.json();
    const item = Array.isArray(data.items) ? (data.items[0]||{}) : data;

    const isContract = !!item.is_contract;
    const token = item.token || {};
    const txs = Number(item.transactions_count||0);
    const holders = Number(token.holders_count||0);
    const verified = !!item.is_verified;
    const reputation = item.reputation || token.reputation || null;

    const bal = toFloat(item.coin_balance);
    const rate = pickRate(item, data);
    const usd = bal * rate;

    const type = (isContract && token.symbol) ? "token" : "wallet";
    const symbol = token.symbol || (type==='token' ? 'TOKEN' : 'WPLS');
    const message = eroticMessage({ type, usd, txs, holders, verified, reputation });
    const titleLine = composeTitle(addr, usd);

    addCard({ address: addr, usd, balance: bal, symbol, message, icon: token.icon_url, type });

    await fetch("/api/record", {
      method:"POST", headers:{'content-type':'application/json'},
      body: JSON.stringify({ address: addr, type, symbol, usd, balance: bal, titleLine, message })
    });

    loadTrending();
    apiStatus.textContent = "OK";
  }catch(e){
    apiStatus.textContent = e.message || "error";
  }
}

function addCard({address, usd, balance, symbol, message, icon, type}){
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <div class="live">LIVE</div>
    <div class="thumb">${icon ? `<img src="${icon}" alt="token" style="max-height:90%;max-width:90%">` : (type==='token'?'TOKEN':'WALLET')}</div>
    <div class="titleLine">${composeTitle(address, usd)}</div>
    <div class="meta"><span>Addr: ${shortAddr(address)}</span><span>Bal: ${balance.toLocaleString(undefined,{maximumFractionDigits:4})} ${symbol}</span></div>
    <div class="meta"><span>Type: ${type}</span><span></span></div>
    <div class="banner" style="margin-top:8px">${message}</div>
    <div class="shareRow">
      <button class="btn twitter">Share</button>
      <a class="btn" target="_blank" href="https://scan.pulsechain.com/address/${address}">Explorer</a>
    </div>`;
  card.querySelector('.btn.twitter').onclick = ()=>{
    const text = composeTitle(address, usd) + " " + message + " #PulseChain #WPLS #OrionPeepShow";
    const url = "https://twitter.com/intent/tweet?text="+encodeURIComponent(text)+"&url="+encodeURIComponent(location.href+"?addr="+address);
    window.open(url,'_blank');
  };
  grid.prepend(card);
  while(grid.children.length>MAX_CARDS) grid.removeChild(grid.lastChild);
}

async function loadTrending(){
  try{
    const r = await fetch("/api/trending?limit=10");
    const j = await r.json();
    renderList(trendWallets, j.wallets);
    renderList(trendTokens,  j.tokens);
  }catch(e){
    trendWallets.innerHTML = `<div class="muted">no data</div>`;
    trendTokens.innerHTML  = `<div class="muted">no data</div>`;
  }
}

function renderList(el, arr){
  if(!arr || !arr.length){ el.innerHTML = `<div class="muted">no data</div>`; return; }
  el.innerHTML = arr.map(it=>{
    const t = it.titleLine || composeTitle(it.address, it.usd||0);
    return `<div class="li"><span>${shortAddr(it.address)} <span class="muted">(${it.type}${it.symbol?": "+it.symbol:""})</span></span><span>x${it.count}</span></div>
            <div class="muted" style="padding:4px 0">${t}</div>`;
  }).join("");
}

document.getElementById('buyBtn').onclick = ()=> window.open(PULSEX_BUY_URL,"_blank");
document.getElementById('analyzeBtn').onclick = ()=>{
  const a = addrInput.value.trim();
  if(!/^0x[a-fA-F0-9]{40}$/.test(a)){ alert('Paste a valid 0x address'); return; }
  analyze(a);
};
addrInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') document.getElementById('analyzeBtn').click(); });
document.getElementById('tweetSite').onclick = ()=>{
  const text = "Watching wallets go full exhibitionist at PORN – Orion Peep Show. Expose yours. #PulseChain #WPLS";
  window.open("https://twitter.com/intent/tweet?text="+encodeURIComponent(text)+"&url="+encodeURIComponent(location.href),'_blank');
};

loadTrending();
</script>
</body>
</html>

